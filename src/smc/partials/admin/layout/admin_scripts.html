<script type="text/javascript">
    /*global $*/

    var url = (function() {
        function qs(key) {
            key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
            var match = location.search.match(new RegExp("[?&]" + key + "=([^&]+)(&|$)"));
            return match && decodeURIComponent(match[1].replace(/\+/g, " "));
        }
        return {
            param: qs
        };
    }());

    var store = (function() {
        return {
            get: function() {
                var encoded = window.localStorage.getItem('SMCADMIN') || window.btoa(JSON.stringify({}));
                //console.debug('encoded', encoded, '| {}->', window.btoa(JSON.stringify({})));
                var local = JSON.parse(window.atob(encoded));
                return local;
            },
            set: function(o) {
                window.localStorage.setItem('SMCADMIN', window.btoa(JSON.stringify(o || {})));
            }
        };
    }());

    var ws = (function() {
        return {
            login: function(pass) {
                firebase.auth().signInWithEmailAndPassword('smc_admin@noresponse.com', pass).catch(function(error) {
                    console.warn(error);
                });
            },
            logout: function(success) {
                firebase.auth().signOut().then(function() {
                    // Sign-out successful.
                    console.log('out');
                    success && success();
                }, function(error) {
                    // An error happened.
                    console.warn(error);
                });
            },
            reset: function() {

                var ref = firebase.database().ref('/admin');

                ref.set(null);
                ref.child('partials').push({
                    fileName: 'hola.html',
                    content: '123'
                })

            },
            ref:function(){
                var ref = firebase.database().ref('/admin');
                return ref;
            },
            collection: function(n) {
                var ref = firebase.database().ref('/admin/' + n);
                return {
                    paginate: function(len) {
                        var currentPage = 0;
                        var items = [];
                        return {
                            next: function(callback) {
                                currentPage++;
                                ref.orderByKey().startAt((currentPage * len).toString()).limitToFirst(len).once('value', function(snap) {
                                    var items = [];
                                    snap.forEach(function(snap) {
                                        var o = snap.val();
                                        o.key = snap.key;
                                        items.push(o);
                                    });
                                    callback(items);
                                });
                            }
                        }
                    }
                }
            }
        };
    }());


    function logout() {
        ws.logout(function() {
            window.location = '/admin';
        });
    }
</script>